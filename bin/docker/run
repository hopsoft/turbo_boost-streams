#!/bin/bash


# ============================================================================================================
# Jemalloc setup, SEE: https://jemalloc.net
# ============================================================================================================
jemalloc="/usr/lib/x86_64-linux-gnu/libjemalloc.so.2"
if [ "$(uname -m)" = "x86_64" ] && [ -f "$jemalloc" ]; then
  export LD_PRELOAD = $jemalloc
fi

jemalloc="/usr/lib/aarch64-linux-gnu/libjemalloc.so.2"
if [ "$(uname -m)" = "aarch64" ] && [ -f "$jemalloc" ]; then
  export LD_PRELOAD = $jemalloc
fi


# ============================================================================================================
# Remote setup... ignored when running locally
# ============================================================================================================
if [ -n "$FLY_PUBLIC_IP" ]; then
  mkdir -p /mnt/external/bundle /mnt/external/node_modules
  rm -rf /opt/turbo_boost-streams/node_modules
  ln -s /mnt/external/node_modules /opt/turbo_boost-streams/node_modules
fi


# ============================================================================================================
# Install dependencies
# ============================================================================================================
cd /opt/turbo_boost-streams
yarn
bundle


# ============================================================================================================
# Run the application
# ============================================================================================================
cd /opt/turbo_boost-streams/test/dummy
rm -rf tmp/pids/*
bin/rails assets:clean assets:precompile
bin/rails server --binding=0.0.0.0 --port=3000
